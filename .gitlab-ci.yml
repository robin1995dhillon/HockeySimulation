image: docker:18-git

services:
  - name: docker:18.09-dind

stages:
  - build
  - test
  - deploy_test
  - deploy_prod


build:
  image: maven:3-jdk-8
  stage: build
  tags:
    - dalfcs_docker_kvm
  script:
    - mvn compile
  artifacts:
    paths:
      - target
test:
  image: maven:3-jdk-8
  stage: test
  tags:
    - dalfcs_docker_kvm
  script:
    - mvn clean verify
  artifacts:
    when: always
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml



deployProd:
  image: maven:3-jdk-8
  stage: deploy_prod
  tags:
    - dalfcs_docker_kvm
  #  artifacts:
  #    paths:
  #      # Change this directory to the path that contains your built executable
  #      - target
  before_script:
    - echo "beforeScript"
    - which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )
    - eval $(ssh-agent -s)
    - ssh-add <(echo "${DEPLOY_SSH_KEY}")

  script:
    - databaseFile="application.properties"
    - echo "PROD_URL= ${PROD_URL}" >> databaseFile
    - echo "PROD_USER= ${PROD_USER}" >> databaseFile
    - echo "PROD_PASS= ${PROD_PASS}" >> databaseFile
    - scp -r -o StrictHostKeyChecking=no ${databaseFile} "${DEPLOY_USER_PROD}@${DEPLOY_HOST_PROD}:${DEPLOY_DIR_PROD}/${databaseFile}"
    - zip -r ${CI_COMMIT_SHORT_SHA}.zip target
    - scp -r -o StrictHostKeyChecking=no ${CI_COMMIT_SHORT_SHA}.zip "${DEPLOY_USER_PROD}@${DEPLOY_HOST_PROD}:${DEPLOY_DIR_PROD}/${CI_COMMIT_SHORT_SHA}.zip"
  only:
    - release

deployTest:
  image: maven:3-jdk-8
  stage: deploy_test
  tags:
    - dalfcs_docker_kvm
  artifacts:
    paths:
      - target

  before_script:
    - echo "beforeScript"
    - which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )
    - eval $(ssh-agent -s)
    - ssh-add <(echo "${DEPLOY_SSH_KEY}")

  script:
    - database="application.properties"
    - echo "TEST_URL= ${TEST_URL}" >> $database
    - echo "TEST_USER= ${TEST_USER}" >> $database
    - echo "TEST_PASS= ${TEST_PASS}" >> $database
    - scp -r -o StrictHostKeyChecking=no ${database} "${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_DIR}/${database}"
    - zip -r ${CI_COMMIT_SHORT_SHA}.zip target
    - scp -r -o StrictHostKeyChecking=no ${CI_COMMIT_SHORT_SHA}.zip "${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_DIR}/${CI_COMMIT_SHORT_SHA}.zip"
  only:
    - develop